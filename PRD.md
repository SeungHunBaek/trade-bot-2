# passive-money PRD (v0)

## 1. 배경과 목표
- 빗썸 스팟 시장을 대상으로 자동 매매 시스템을 구축한다.
- 1m/5m 캔들 데이터를 기반으로 전략 생성/검증/배포/실행 파이프라인을 완성한다.
- 페이퍼 트레이딩을 필수 단계로 두어 안정성을 확보한다.
- 로컬 환경에서 운영 가능하도록 설계한다.
- 추후 바이비트/OKX 확장을 고려한 구조를 갖춘다.

## 2. 성공 기준 (초안 KPI)
- 데이터 수집 지연: 1m 캔들 기준 평균 2분 이내 적재
- 백필 안정성: 월 단위 백필 실패율 < 1%, 재시도 성공률 99% 이상
- 주문 처리 성공률: 전송 실패율 < 0.5%
- 대시보드 상태 표시 지연: 5초 이내

## 3. 범위
### 3.1 In Scope
- 빗썸 스팟 1m/5m 캔들 수집/저장
- 2020-01-01부터 월 단위 백필 + 재시도 큐
- 전략 생성/백테스트/승인 플로우
- 페이퍼 트레이딩 및 라이브 트레이딩
- 지정가 주문, 부분체결/미체결 상태 관리
- 리스크 설정 UI 및 즉시 적용
- 성과 지표(잔고, 기간별 수익, 승률)
- 거래소 계정 등록 UI
- 텔레그램 알림(Info/Warning/Critical)

### 3.2 Out of Scope (v0)
- 선물/레버리지 거래
- 마켓메이킹 전용 엔진
- 멀티 사용자/멀티 계정 운영
- 고빈도/틱 기반 전략

## 4. 사용자 시나리오
1) 사용자는 UI에서 거래소 계정을 등록한다 (API key/secret, OKX는 password 포함).
2) 백필 작업을 실행하여 2020-01-01부터 캔들 데이터를 적재한다.
3) 전략을 생성하고 백테스트를 수행한다.
4) 백테스트 통과 전략을 수동 승인 후 페이퍼로 실행한다.
5) 페이퍼 성과 확인 후 수동 승인하여 라이브 전환한다.
6) 대시보드에서 심볼별 차트와 주문(매수/매도) 마커를 확인한다.

## 5. 기능 요구사항
### 5.1 데이터 수집/백필
- 빗썸 1m/5m 캔들을 수집하고 Postgres에 저장한다.
- 백필은 월 단위 배치로 실행하고 실패 시 재시도 큐를 사용한다.
- 중복 캔들은 (exchange, symbol, timeframe, timestamp) 기준으로 방지한다.

### 5.2 전략 생성/백테스트
- Python 기반 전략 연구/백테스트 워크플로우를 제공한다.
- 전략은 알파/모멘텀/리버전/마켓메이킹 순서로 확장 가능해야 한다.
- 전략 결과는 Strategy Registry에 버전으로 기록한다.

### 5.3 전략 승인 플로우
- 상태 전이: DRAFT → BACKTEST_PASS → APPROVED_FOR_PAPER → PAPER → APPROVED_FOR_LIVE → LIVE
- 승인자는 수동으로 상태 변경한다.

### 5.4 실행 엔진 (페이퍼/라이브)
- 전략 인스턴스는 멀티심볼 구성을 지원한다.
- 페이퍼 트레이딩은 캔들 종가 체결을 기본으로 한다.
- 주문 정책과 리스크 설정은 즉시 반영된다.

### 5.5 주문/체결/포지션
- 지정가 주문만 우선 지원한다.
- 주문 상태: NEW → OPEN → PARTIAL → FILLED | CANCELED | REJECTED | EXPIRED
- 부분체결은 여러 fill 이벤트로 기록된다.
- 미체결 주문은 전략의 정책에 따라 재가격/취소 가능해야 한다.

### 5.6 리스크 관리
- Risk per trade: 자산 1% (최대 2%)
- Daily loss limit: 3~5%
- Position limit: 자산 20~25%, 마켓별 제한
- Slippage tolerance: 0.2~0.5%
- UI 변경 즉시 적용

### 5.7 대시보드 (Next.js)
- 거래소/계정 등록 및 관리 화면
- 거래소/심볼별 차트 화면
- 차트에 BUY/SELL 및 부분체결 마커 표시
- 주문/체결 리스트, 상태 필터
- 성과 지표: 현재 잔고, 기간별 수익(일간/주간/월간/커스텀), 승률(포지션 단위)

### 5.8 알림
- 텔레그램 알림
- 레벨: Info/Warning/Critical
- 이벤트: 주문 실패/체결 실패/리스크 초과/데이터 수집 지연

## 6. 비기능 요구사항
- 로컬 환경 운영(개발/테스트/실거래 분리)
- 장애 발생 시 재시도 및 장애 로그 확보
- 데이터 무결성(캔들 중복 방지, 주문 상태 일관성)
- API 키는 로컬 저장(암호화 여부 TBD)

## 7. 데이터/스키마 요구사항
- Postgres 기본, Redis(BullMQ) 사용
- 기존 SQLite 데이터(`trading-bot.sqlite`)를 Postgres로 마이그레이션
- 주요 테이블: candles, orders, fills, positions, strategies, strategy_versions, strategy_instances, risk_settings, portfolio

## 8. 릴리즈 단계 (초안)
- MVP: 데이터 수집/백필 + 전략 백테스트 + 페이퍼 실행 + 대시보드
- v1: 라이브 실행 + 알림/리스크 완성 + 멀티심볼 안정화
- v2: 해외 거래소 확장(바이비트/OKX)

## 9. 의존성
- Bithumb API
- Redis (BullMQ)
- Postgres
- Telegram Bot API

## 10. 리스크 및 가정
- 거래소 API 제한/변경에 대한 대응 필요
- 페이퍼 체결 모델 단순화로 실제 체결과 차이 발생 가능
- 로컬 운영 시 키 관리/백업 전략 필요

## 11. 미해결 질문 (TBD)
- 멀티심볼 전략의 리스크는 심볼별 제한만 둘지, 전략 묶음 공통 제한도 둘지?
- 페이퍼 체결에 슬리피지/거래량 제한을 반영할지?
- API 키 로컬 저장 시 암호화 적용 여부?
- 차트 라이브러리 선택: TradingView vs lightweight-charts?
- 캔들 테이블 월 단위 파티셔닝 필요 여부?
